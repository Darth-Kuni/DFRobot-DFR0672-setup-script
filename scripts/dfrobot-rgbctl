#!/usr/bin/env bash
set -euo pipefail

if [[ $EUID -ne 0 ]]; then
  exec sudo "$0" "$@"
fi

ACTION="${1-}"

case "$ACTION" in
  enable)
    systemctl enable --now dfrobot-rgb.service
    systemctl status dfrobot-rgb.service --no-pager
    ;;
  disable)
    systemctl disable --now dfrobot-rgb.service
    systemctl status dfrobot-rgb.service --no-pager
    ;;
  temp)
    sed -i 's/^MODE=.*/MODE=temp/' /etc/dfrobot-rgb.conf
    systemctl restart dfrobot-rgb.service
    ;;
  fixed)
    if [[ $# -ne 4 ]]; then
      echo "usage: $0 fixed R G B" >&2
      exit 1
    fi
    sed -i 's/^MODE=.*/MODE=fixed/' /etc/dfrobot-rgb.conf
    sed -i "s/^RGB_R=.*/RGB_R=$2/" /etc/dfrobot-rgb.conf
    sed -i "s/^RGB_G=.*/RGB_G=$3/" /etc/dfrobot-rgb.conf
    sed -i "s/^RGB_B=.*/RGB_B=$4/" /etc/dfrobot-rgb.conf
    systemctl restart dfrobot-rgb.service
    ;;
  interval)
    if [[ $# -ne 2 ]]; then
      echo "usage: $0 interval SECONDS" >&2
      exit 1
    fi
    sed -i "s/^FIXED_INTERVAL=.*/FIXED_INTERVAL=$2/" /etc/dfrobot-rgb.conf
    systemctl restart dfrobot-rgb.service
    ;;
  rainbow)
    sed -i 's/^MODE=.*/MODE=rainbow/' /etc/dfrobot-rgb.conf
    systemctl restart dfrobot-rgb.service
    ;;
  speed)
    if [[ $# -ne 2 ]]; then
      echo "usage: $0 speed SECONDS" >&2
      exit 1
    fi
    sed -i "s/^RAINBOW_DELAY=.*/RAINBOW_DELAY=$2/" /etc/dfrobot-rgb.conf
    systemctl restart dfrobot-rgb.service
    ;;
  red)    "$0" fixed 255 0 0 ;;
  green)  "$0" fixed 0 255 0 ;;
  blue)   "$0" fixed 0 0 255 ;;
  cyan)   "$0" fixed 0 255 255 ;;
  purple) "$0" fixed 128 0 255 ;;
  orange) "$0" fixed 255 128 0 ;;
  white)  "$0" fixed 255 255 255 ;;
  warmwhite) "$0" fixed 255 200 120 ;;
  pink)   "$0" fixed 255 64 128 ;;
  status)
    systemctl status dfrobot-rgb.service --no-pager
    ;;
  *)
    echo "usage: $0 {enable|disable|temp|fixed R G B|interval SECONDS|rainbow|speed SECONDS|red|green|blue|cyan|purple|orange|white|warmwhite|pink|status}" >&2
    exit 1
    ;;
 esac
